# Интеграция ИИ-ассистента в систему записи

## Обзор

В проекте Booking Assistant ИИ-ассистент выступает в роли интеллектуального интерфейса, позволяющего пользователям взаимодействовать с системой записи на естественном языке. Интеграция ИИ-ассистента осуществляется через Model Context Protocol (MCP), который обеспечивает структурированный обмен данными между языковой моделью и бизнес-логикой приложения.

## Роль ИИ-ассистента

ИИ-ассистент выполняет следующие функции:

1. **Понимание естественного языка** - распознавание намерений пользователей из их сообщений
2. **Ведение диалога** - поддержание логической последовательности разговора
3. **Определение недостающей информации** - запрос дополнительных данных у пользователя
4. **Генерация ответов** - формирование грамматически корректных и контекстно-релевантных ответов
5. **Выполнение действий** - вызов соответствующих функций API через MCP

## Архитектура взаимодействия

```
+---------------+     +---------------+     +---------------+     +---------------+
|               |     |               |     |               |     |               |
| Пользователь  | <-> | Telegram Bot  | <-> | MCP Server    | <-> | ИИ-модель     |
|               |     |               |     |               |     |               |
+---------------+     +---------------+     +---------------+     +---------------+
                                               |
                                               v
                                        +---------------+
                                        |               |
                                        | Django API    |
                                        |               |
                                        +---------------+
```

## Процесс интеграции с MCP

### 1. Определение функций (Function Calling)

Функции - это действия, которые ИИ-ассистент может выполнить через API. Каждая функция имеет следующие атрибуты:

- **name** - уникальное имя функции
- **description** - описание назначения функции
- **parameters** - параметры, которые функция принимает
- **required** - обязательные параметры

Пример определения функции в формате JSON Schema:

```json
{
  "name": "get_specialist_services",
  "description": "Получить услуги, предоставляемые конкретным специалистом",
  "parameters": {
    "type": "object",
    "properties": {
      "specialist_id": {
        "type": "integer",
        "description": "Идентификатор специалиста"
      }
    },
    "required": ["specialist_id"]
  }
}
```

### 2. Управление контекстом

Контекст хранит информацию о текущем состоянии диалога и используется для принятия решений ИИ-ассистентом. Контекст включает:

- **user_info** - информация о пользователе
- **conversation_state** - текущее состояние диалога
- **selected_entities** - выбранные пользователем сущности
- **recent_actions** - недавние действия
- **temporal_info** - временная информация

### 3. Распознавание интентов

Интенты (намерения) представляют собой цели пользователя. Примеры интентов:

- `find_specialist` - найти специалиста
- `book_appointment` - записаться на прием
- `cancel_appointment` - отменить запись
- `get_schedule` - узнать расписание
- `get_service_info` - получить информацию об услуге

### 4. Обработка диалога

Процесс обработки диалога включает следующие шаги:

1. Пользователь отправляет сообщение через Telegram Bot
2. Telegram Bot передает сообщение и текущий контекст в MCP Server
3. MCP Server формирует промпт для ИИ-модели, включая сообщение, контекст и доступные функции
4. ИИ-модель анализирует промпт и принимает решение:
   - Запросить дополнительную информацию у пользователя
   - Вызвать одну или несколько функций
   - Сгенерировать ответ без вызова функций
5. MCP Server обрабатывает ответ ИИ-модели:
   - Если требуется вызов функции, MCP Server выполняет соответствующий API-запрос
   - Результаты вызова функций включаются в обновленный контекст
6. MCP Server формирует ответ пользователю и обновленный контекст
7. Telegram Bot отображает ответ пользователю

## Примеры промптов для ИИ-модели

### Промпт для распознавания намерения

```
Пользователь: Хочу записаться к стоматологу

Контекст:
{
  "user_info": {
    "id": 12345,
    "name": "Иван",
    "is_registered": true
  },
  "conversation_state": "initial",
  "selected_entities": {}
}

Доступные функции:
- get_specialists(specialization)
- get_specialist_services(specialist_id)
- get_available_slots(specialist_id, date)
- book_appointment(client_id, specialist_id, service_id, date, time)

Определи намерение пользователя и вызови соответствующую функцию, если нужно.
```

### Промпт для управления записью

```
Пользователь: Запишите меня на завтра на 15:00

Контекст:
{
  "user_info": {
    "id": 12345,
    "name": "Иван",
    "is_registered": true
  },
  "conversation_state": "selecting_time",
  "selected_entities": {
    "specialist_id": 3,
    "specialist_name": "Иванов И.И.",
    "service_id": 5,
    "service_name": "Консультация"
  }
}

Доступные функции:
- get_available_slots(specialist_id, date)
- book_appointment(client_id, specialist_id, service_id, date, time)

Обработай запрос пользователя и вызови соответствующую функцию, если нужно.
```

## Оптимизация качества взаимодействия

Для повышения качества взаимодействия ИИ-ассистента с пользователями, следует применять следующие подходы:

1. **Специфичные промпты** - создание детальных инструкций для ИИ-модели
2. **Fine-tuning** - дополнительное обучение ИИ-модели на специфичных примерах взаимодействия
3. **Контроль контекста** - ограничение размера и структурирование контекста
4. **Логирование и анализ** - отслеживание взаимодействий для выявления проблем
5. **A/B тестирование** - сравнение различных подходов к формированию промптов

## Безопасность и этика

При интеграции ИИ-ассистента необходимо учитывать следующие аспекты:

1. **Конфиденциальность данных** - минимизация передачи персональных данных в промптах
2. **Проверка входных данных** - валидация запросов пользователей перед обработкой
3. **Модерация контента** - предотвращение вредоносных или неприемлемых запросов
4. **Прозрачность** - информирование пользователей о взаимодействии с ИИ
5. **Контроль ответов** - предотвращение генерации некорректной информации

## Метрики эффективности

Для оценки эффективности ИИ-ассистента следует отслеживать следующие метрики:

1. **Точность распознавания интентов** - доля правильно распознанных намерений
2. **Скорость разрешения запросов** - среднее время от запроса до успешного выполнения
3. **Количество итераций** - среднее число сообщений для выполнения задачи
4. **Удовлетворенность пользователей** - обратная связь от пользователей
5. **Конверсия** - процент успешных записей от общего числа попыток

## Дальнейшее развитие

Возможные направления развития ИИ-ассистента:

1. **Многоязычная поддержка** - добавление поддержки разных языков
2. **Голосовое управление** - интеграция голосового ввода/вывода
3. **Персонализация** - адаптация ответов под конкретного пользователя
4. **Проактивные рекомендации** - предложение услуг на основе истории клиента
5. **Расширенная аналитика** - анализ паттернов взаимодействия для улучшения системы 